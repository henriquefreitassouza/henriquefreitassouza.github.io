<!DOCTYPE html>
<html class="" lang="pt" dir="ltr">
  <head>
    <title>RD Station e Google Sheets Parte 2 - Migrando para a AWS | Automação de Dados</title>



<meta http-equiv="Content-Type" content="text/html" charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="RD Station e Google Sheets Parte 2 - Migrando para a AWS | Automação de Dados" />

<meta property="og:url" content="https://www.automacaodedados.com.br/stories/rd-station-e-google-sheets-na-aws/">
<meta property="og:locale" content="pt" />
<meta property="og:title" content="RD Station e Google Sheets Parte 2 - Migrando para a AWS | Automação de Dados">
<meta property="og:description" content="RD Station e Google Sheets Parte 2 - Migrando para a AWS | Automação de Dados">
<meta property="og:site_name" content="Automação de Dados">

<meta name="twitter:card" content="summary_large_image">


<meta property="og:type" content="article">
<meta property="article:author" content="Henrique Freitas Souza" />
<meta property="article:published_time" content="2020-09-03 19:23:00 &#43;0000 UTC" />
<meta property="article:modified_time" content="2021-11-19 19:23:00 &#43;0000 UTC" />
<meta name="twitter:label1" content="Tempo estimado para a leitura" />
<meta name="twitter:data1" content="26 minutos" />

<meta property="article:tag" content="Automação" />
<meta property="article:section" content="Automação" />



<meta property="og:image" content="https://www.automacaodedados.com.br/stories/rd-station-e-google-sheets-na-aws/images/thumbnail.jpg">
<meta name="twitter:image" content="https://www.automacaodedados.com.br/stories/rd-station-e-google-sheets-na-aws/images/thumbnail.jpg">
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="400" />

<meta name="og:image:alt" content="Logotipos do RD Station, Google Sheets e Amazon Web Services.">

    <link href="https://www.automacaodedados.com.br/images/favicon.ico" rel="icon" type="image/x-icon" />

	
	<link rel="alternate" hreflang="en" href="https://www.automacaodedados.com.br/en/stories/rd-station-e-google-sheets-na-aws/" title="English">
	

<link rel="preload" as="script" href="/js/ui.min.js" />
<link rel="preload" as="script" href="/js/theme.min.js" />
<link rel="preload" as="style" href="/css/fonts.min.css" />
<link rel="preload" as="style" href="/css/main.min.css" />
<link rel="stylesheet" href="/css/fonts.min.css" />
<link rel="stylesheet" href="/css/main.min.css" />
<script src="/js/ui.min.js" async></script>

    
  </head>
  <body class="overflow-x-hidden dark:bg-secondary">
    <div class="flex flex-col h-screen">
      <a class="sr-only focus:sr-only" href="#content">Pular para o conteúdo</a>
      <header class="flex flex-col justify:between">
  <div class="container container-box mx-auto lg:px-0">
    <div class="px-2 flex flex-wrap justify-between items-center">
      <div class="w-6/12 md:w-auto">
        <a href="/" class="flex items-center mr-2 font-title no-underline hover:no-underline focus:outline-none focus:ring-2 focus:ring-offset-8 focus:ring-secondary-darker dark:ring-offset-secondary dark:ring-white">
          <img class="mr-2 w-16 h-8" id="site-logo" src="https://www.automacaodedados.com.br/images/automacaodedados_logo.svg" alt="Logo Automação de Dados">
          <span class="text-base font-title leading-none mb-0 break-words dark:text-white">Automação de Dados</span>
        </a>
      </div>
      <div class="flex items-center lg:order-last">
        <a class="p-2 mr-2 inline-block no-underline focus:outline-none focus:ring-2 focus:ring-secondary-darker dark:focus:ring-white lg:mr-0 lg:ml-2" id="theme-menu-toggle" href="#" title="Trocar entre temas escuro e claro">
          <span class="sr-only">Trocar entre temas escuro e claro</span>
          <i class="w-7 h-7" id="theme-toggle-icon"></i>
        </a>
        <a id="navigation-menu-toggle" class="p-2 inline-block text-base no-underline focus:outline-none focus:ring-2 focus:ring-secondary-darker dark:focus:ring-white lg:hidden" role="button" aria-owns="main-menu" aria-controls="main-menu" aria-expanded="false" href="#main-menu">
          <span class="sr-only">Abrir e fechar navegação principal</span>
          <i class="navigation-menu-icon w-7 h-7 dark:filter dark:invert" id="navigation-toggle-icon"></i>
        </a>
      </div>
      <div id="main-menu" class="flex flex-grow mt-4 hidden targeted:block lg:block lg:w-auto lg:mt-0" aria-labelledby="navigation-menu-toggle">
  <div class="container mx-auto">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-end">
      <nav role="navigation" itemscope itemtype="https://schema.org/SiteNavigationElement">
        <ul class="ml-auto mb-2 lg:mb-0">
          
          <li class="list-none lg:inline-block" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a class="py-2 inline-block no-underline hover:text-gray-900 hover:underline dark:hover:text-white lg:p-2 lg:mr-2" href="/stories" itemprop="item">
              <span class="text-base dark:text-white" itemprop="name">Todas as Histórias</span>
            </a>
          </li>
          
        </ul>
      </nav>
      <div itemscope itemtype="https://schema.org/WebSite">
  <form class="inline-search flex p-2 mb-2 border-2 rounded-lg dark:bg-white lg:mb-0" itemprop="potentialAction" itemscope itemtype="https://schema.org/SearchAction" action="/search/" role="search" method="get">
    <meta itemprop="target" content="https://www.automacaodedados.com.br/search/">
    <label class="sr-only" for="q">Buscar histórias</label>
    <input class="text-sm px-4 w-full focus:outline-none focus:border-transparent dark:text-gray-900" itemprop="query" id="q" name="q" type="search" aria-label="Buscar em todo o site" placeholder='Buscar histórias'>
    <button class="p-2 text-base focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary-darker" type="submit">
      <span class="sr-only">Iniciar a busca</span>
      <i class="search-icon w-4 h-4"></i>
    </button>
  </form>
</div>

    </div>
  </div>
</div>

    </div>
  </div>
</header>

      <main id="content" class="flex-grow">
        


<article role="article" itemscope itemtype="https://schema.org/Article">
  <header>

  


  
  
  
  
  
<div class="relative py-8">
  
    
  <div class="absolute inset-0 bg-cover bg-center filter brightness-75" style="background-image: url('/stories/rd-station-e-google-sheets-na-aws/images/thumbnail_hu4a2eaaaa0922d32f9b411fc58706e27f_32210_1024x400_fill_q75_box_smart1.jpg');"></div>
  
  <div class="relative container container-box mx-auto">
    <div class="flex justify-between items-center mb-6 px-2">
      <div class="flex flex-col lg:flex-row">
        
        <address class="text-white text-base" itemprop="author">Henrique</address>
        <time class="text-white text-base lg:ml-2" pubdate datetime="2020-09-03 19:23:00 &#43;0000 UTC" itemprop="datePublished">03/09/2020 19:23:00</time>
        
      </div>
      <a class="badge dark:ring-offset-secondary-darker" href="/categories/automa%c3%a7%c3%a3o" itemprop="articleSection">automação</a>
    </div>
    <div class="flex flex-col px-2">
      
      <div>
        <h1 class="text-white text-5xl break-words lg:text-6xl lg:break-normal" itemprop="headline">RD Station e Google Sheets Parte 2 - Migrando para a AWS</h1>
      </div>
      <div>
        
        <p class="text-white text-2xl" itemprop="abstract">Já vimos neste blog como fazer para enviar leads do RD Station para uma planilha automaticamente. Agora vamos ver como enviar estes mesmos leads para um banco de dados hospedado na AWS</p>
        
      </div>
      
    </div>
  </div>
</div>



  </header>
  <div class="bg-secondary hidden dark:bg-neutral lg:block">
    <div class="container container-box mx-auto">
      <div class="px-2">
      <nav aria-label="Breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
  <ul class="flex ml-auto mb-0">
    
  
    
  
    
  

  
  <li class="flex relative pr-7 last:pr-0 dark:filter dark:invert" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
    <a class="text-white no-underline hover:text-white hover:underline dark:hover:text-gray-100" href="/" itemprop="item">
      
      <span class="text-white" itemprop="name">Home</span>
      
    </a>
    <i class="breadcrumb-separator"></i>
  </li>
  

  

  
  <li class="flex relative pr-7 last:pr-0 dark:filter dark:invert" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
    <a class="text-white no-underline hover:text-white hover:underline dark:hover:text-gray-100" href="/stories/" itemprop="item">
      
        <span class="text-white" itemprop="name">Todas as histórias</span>
      
    </a>
    <i class="breadcrumb-separator"></i>
  </li>
  

  

  
  <li class="flex relative pr-7 last:pr-0 dark:filter dark:invert" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
    <a class="text-white no-underline hover:text-white hover:underline dark:hover:text-gray-100" href="/stories/rd-station-e-google-sheets-na-aws/" aria-current="page" itemprop="item">
      <span class="text-white" itemprop="name">RD Station e Google Sheets Parte 2 - Migrando para a AWS</span>
    </a>
  </li>
  

  </ul>
</nav>



      </div>
    </div>
  </div>
  <div class="container container-box mx-auto">
    <div class="max-w-3xl px-2 mx-auto flex flex-col">
      <main id="post" itemprop="articleBody">
        <strong class="inline-block text-base mb-4 dark:text-white">Tempo estimado para a leitura: 26 minutos</strong>
        <p>Publicado em 03/09/2020 e atualizado em 19/11/2021.</p>
<p><strong>ALERTA DE SPOILER: Este post contém linhas de código! Assumo que você tenha familiaridade com SQL, Javascript e Node.js</strong>.</p>
<p>Há exatos 2 anos eu escrevi um post neste blog explicando <a href="/stories/rd-station-e-google-sheets" >como criar uma integração entre RD Station e Google Sheets</a>. Com apenas um webhook, um fluxo de automação e algumas linhas de código, é possível automatizar o envio de leads para planilhas e diminuir o tempo gasto com a coleta de dados. Para uma operação pequena o procedimento funciona bem, mas e quando a base de dados começa a ficar grande, há diversas pessoas usando e performance começa a virar uma questão? É hora de migrar para uma arquitetura mais robusta.</p>
<h2 id="os-limites-de-uma-planilha">Os limites de uma planilha</h2>
<p>O primeiro problema com uma integração que utilize webhooks do RD Station já é sentido logo ao ligar a automação utilizando listas de segmentação grandes (acima de 3.000 leads): o de sobrescrita de linhas na planilha. Cada lead é enviado pelo webhook individualmente, tornando necessária a gestão de múltiplos acessos ao script com permissão para escrita na planilha. O Google Apps Script (ou GAS) <a href="https://developers.google.com/apps-script/guides/services/quotas" target="_blank" rel="noopener">limita o número de execuções simultâneas de um script a 30 por usuário</a>. Como no post anterior a planilha foi configurada para autenticar usuários anônimos utilizando as credenciais de um usuário com permissão de escrita da planilha, cada chamada ao script pelo webhook consome da cota por usuário. Um sistema de trava e destrava foi criado para gerenciar os acessos simultâneos, mas ainda assim ineficaz para gerir muitos leads sendo enviados pelo webhook simultaneamente.</p>
<p>O problema pode ser contornado ao determinar uma data de corte e criar duas listas de segmentação de leads por data de criação: uma até a data de corte e uma depois da data de corte. Todos os leads criados até a data de corte são então cadastrados manualmente na planilha e a automação é ligada a partir da lista de leads após o corte. Resolvido o problema, a planilha passa a ser alimentada com dados de novos leads, até que uma das coisas começa a acontecer:</p>
<ul>
<li>O limite de células é atingido ou está próximo do fim;</li>
<li>O problema de excesso de chamadas ao GAS se repete em função de muitos novos leads entrando no fluxo de automação simultaneamente;</li>
<li>A planilha, que vive em um diretório no Google Drive, é modificada ou apagada acidentalmente;</li>
<li>O arquivo começa a ficar muito grande e lento para abrir.</li>
</ul>
<p>Estes são apenas os problemas que diminuem a acessibilidade ao arquivo, há de se considerar também as implicações jurídicas de deixar um histórico de leads em um diretório no Google Drive.</p>
<p>Felizmente, o local para onde esta solução será migrada mitiga ou sana os problemas citados e muitos outros.</p>
<h2 id="infraestrutura-em-nuvem">Infraestrutura em nuvem</h2>
<p>Criar e manter uma infraestrutura para coleta, processamento e armazenamento de dados em casa é bem custoso. Considere apenas os custos de antemão com máquinas e pessoal qualificado. Antes mesmo de armazenar um único bit, a empresa que se aventura em criar seu próprio <em>hub</em> de dados possivelmente dedicará meses para fazer com que tudo funcione conforme o planejado. Adicione a burocracia interna para aprovação de tal empreitada e os custos constantes de manutenção e rapidamente você tem um projeto que, provavelmente, não se pagará.</p>
<p>Para abstrair a complexidade de gerir a infraestrutura necessária para dar vida a aplicações, diversas empresas ao redor do mundo oferecem serviços de aluguel de suas próprias infraestruturas: máquinas, equipamentos de rede e pessoal qualificado que cuidam de tudo o que acontece &ldquo;por trás dos panos&rdquo; para que a aplicação seja criada e mantida sem a preocupação de preparar todo o ambiente de hospedagem do zero.</p>
<p>Uma das empresas que oferece tal serviço é a Amazon, com sua divisão de soluções de infraestrutura Amazon Web Services (ou AWS). É a solução da AWS que será utilizada neste post.</p>
<p>Uma pausa antes de seguir: tudo o que será feito na AWS poderia ter sido feito em outro provedor de infraestrutura como serviço (IaaS).</p>
<h2 id="amazon-web-services">Amazon Web Services</h2>
<p>As soluções de computação em nuvem da AWS são preparadas para lidar com diferentes volumes de tráfego: elas &ldquo;escalam&rdquo; conforme a demanda, o que significa dizer que mais recursos da infraestrutura vão sendo alocados conforme a demanda e liberados após o uso. A precificação das ferramentas é feita de acordo com o uso da infraestrutura, não há um valor ou tabela de valores determinado na maioria dos serviços como é com um provedor de hospedagem tradicional. Estes serviços estão divididos em dezenas de categorias e com eles é possível desde armazenar arquivos de texto a processar algoritmos de redes neurais.</p>
<figure >
  
  <img data-src="images/figure1-aws-product-list.webp" class="lazy" alt="As diferentes categorias de serviços oferecidas pela AWS." title="As diferentes categorias de serviços oferecidas pela AWS." />
  
  
  <figcaption>
    <p>As diferentes categorias de serviços oferecidas pela AWS. Fonte: Autor.</p>
  </figcaption>
  
</figure>

<p>Para este exercício, vamos utilizar os seguintes serviços:</p>
<ul>
<li>AWS API Gateway;</li>
<li>AWS Lambda;</li>
<li>AWS RDS MySQL.</li>
</ul>
<p>Juntos, estes serviços serão responsáveis por receber o webhook do RD Station (o mesmo do post anterior), tratar os dados de entrada e inserir estes dados em um banco de dados MySQL.</p>
<figure >
  
  <img data-src="images/figure2-data-pipeline.webp" class="lazy" alt="O desenho da arquitetura a ser montada na AWS." title="O desenho da arquitetura a ser montada na AWS." />
  
  
  <figcaption>
    <p>O desenho da arquitetura a ser montada na AWS. Fonte: Autor.</p>
  </figcaption>
  
</figure>

<h3 id="aws-api-gateway">AWS API Gateway</h3>
<p>O AWS API Gateway é o construtor de APIs da AWS. Com este serviço é possível construir APIs REST e também websockets, para criar aplicativos de mensagem instantânea. Com uma API REST é possível abrir uma porta para escuta do webhook do RD Station.</p>
<h3 id="aws-lambda">AWS Lambda</h3>
<p>O AWS Lambda é um serviço capaz de executar instruções em diferentes linguagens de programação. O serviço irá orquestrar o uso dos demais recursos da infraestrutura e será acionado assim que demandado pela API. Se você conhece a arquitetura MVC (Model, View, Controller), o AWS Lambda vai agir como um controller.</p>
<h3 id="aws-rds-mysql">AWS RDS MySQL</h3>
<p>A AWS tem uma categoria de serviços chamada de RDS, ou Relational Database Service, que suporta diversos bancos de dados conhecidos, como PostgreSQL, MariaDB ou MySQL. Há também um gerenciador de bancos de dados construído em cima do MySQL chamado AWS Aurora, com foco em performance. Neste exercício vamos trabalhar com uma instância do MySQL nativo.</p>
<p>Além dos serviços descritos, vamos precisar de outros três para fazer a publicação da arquitetura:</p>
<ul>
<li>AWS IAM;</li>
<li>AWS VPC;</li>
<li>AWS CloudWatch.</li>
</ul>
<h3 id="aws-iam">AWS IAM</h3>
<p>Todo serviço na AWS possui restrições de acesso. As permissões são concedidas a usuários do sistema e também a outros serviços. O sistema de permissões da AWS é o IAM, ou Identity Access Management.</p>
<h3 id="aws-vpc">AWS VPC</h3>
<p>Além das permissões de usuários, serviços na AWS podem ou não estar isolados da internet. Serviços isolados ficam em uma rede cujas regras são determinadas pelos usuários administradores e os dispositivos dentro desta rede podem ser conectados à internet conforme a liberação de acessos. Esse isolamento é chamado de VPC, ou Virtual Private Cloud. O banco de dados estará dentro desta rede segura.</p>
<h2 id="aws-cloudwatch">AWS CloudWatch</h2>
<p>Cada execução de código no AWS Lambda gera um log de execução. Este log deve, obrigatoriamente, ser armazenado no CloudWatch. O serviço permite o armazenamento e a gestão de quaisquer logs, incluindo as chamadas na API, mas para este exercício apenas o log da execução do código será armazenado.</p>
<p>Cada serviço pode ser configurado nos mínimos detalhes por um painel administrativo, chamado de <strong>console</strong>.</p>
<h2 id="configuração-do-ambiente">Configuração do ambiente</h2>
<p>Identificados os serviços que vão compor a infraestrutura, hora de configurá-los.</p>
<h3 id="criação-da-conta-na-aws">Criação da conta na AWS</h3>
<p>A criação de uma conta na AWS não tem custos. Ao longo do primeiro ano de uso, <a href="https://aws.amazon.com/free/" target="_blank" rel="noopener">diversos serviços são gratuitos</a>, incluindo os que vamos usar ao longo do post.</p>
<p>Para utilizar os serviços, <a href="https://portal.aws.amazon.com/billing/signup#/start" target="_blank" rel="noopener">crie uma conta na AWS</a> e faça login no console.</p>
<figure >
  
  <img data-src="images/figure3-aws-console.webp" class="lazy" alt="O console da AWS." title="O console da AWS." />
  
  
  <figcaption>
    <p>O console da AWS. Fonte: Autor.</p>
  </figcaption>
  
</figure>

<p>Todos os serviços da AWS possuem redundância, o que significa dizer que estão replicados em servidores localizados em diferentes partes do planeta. Você pode escolher em qual região quer trabalhar e como os serviços que você utiliza serão replicados nas demais regiões, para garantir a disponibilidade caso algo venha a acontecer com a infraestrutura onde sua aplicação está hospedada. Ao criar a conta, a região padrão é a Ohio (us-east-2), nos Estados Unidos. Há um centro de dados da AWS em São Paulo (sa-east-1) que pode ser utilizado para servir aplicações que serão utilizadas no Brasil. Para este exercício, mantive a configuração padrão (us-east-2) e o idioma do console em inglês.</p>
<h3 id="criação-do-banco-de-dados">Criação do banco de dados</h3>
<p>A primeira coisa que vamos fazer no ambiente é criar o banco de dados. Para isso, utilize a barra de buscas na tela inicial e digite RDS. Clique no primeiro resultado. O mesmo caminho pode ser feito indo no menu Services. Ao entrar pela primeira vez em um serviço na AWS a página exibida é a página inicial do serviço. Clique no botão &ldquo;Create database&rdquo;.</p>
<figure >
  
  <img data-src="images/figure4-amazon-mysql.webp" class="lazy" alt="Tela de configurações de novo banco MySQL na AWS." title="Tela de configurações de novo banco MySQL na AWS." />
  
  
  <figcaption>
    <p>Tela de configurações de novo banco MySQL na AWS. Fonte: Autor.</p>
  </figcaption>
  
</figure>

<p>Mantenha marcada a opção &ldquo;Standard Create&rdquo;, para exibir todas as configurações.</p>
<p>Selecione o banco de dados MySQL e a edição MySQL Community. Mantenha a versão do MySQL sugerida (na data de escrita deste post, a 8.0.17).</p>
<p>Em templates, selecione Free tier. Vamos utilizar o serviço que é oferecido gratuitamente pelo período de 12 meses.</p>
<p>Configure o nome de identificador da instância do banco de dados e a senha. Este nome não é o nome do banco de dados em si, mas o nome que identifica a instalação do banco de dados e as configurações aplicadas.</p>
<p>Mantenha as configurações de hardware sugeridas.</p>
<p>Em Connectivity, garanta que há uma VPC (Virtual Private Cloud) selecionada. Ao criar um banco de dados, ele é associado a uma VPC.</p>
<p>Expanda as opções clicando em Additional connectivity configuration.</p>
<p>Em Subnet group garanta que o grupo de rede padrão está selecionado.</p>
<p>Em Public access marque a opção Yes. Será possível acessar o banco de dados a partir de serviços fora da VPC, e isso será feito apenas para criar o banco de dados e a tabela onde armazenaremos os dados do RD Station. Finalizada a criação do banco e da tabela, vamos desabilitar o acesso público e deixar que a VPC controle o tráfego que chega até o banco de dados.</p>
<p>Em Existing VPC security groups, selecione a opção default.</p>
<p>Mantenha as demais configurações e clique em Create database.</p>
<figure >
  
  <img data-src="images/figure5-database-created.webp" class="lazy" alt="Tela de detalhes do novo banco de dados criado na AWS." title="Tela de detalhes do novo banco de dados criado na AWS." />
  
  
  <figcaption>
    <p>Tela de detalhes do novo banco de dados criado na AWS. Fonte: Autor.</p>
  </figcaption>
  
</figure>

<p>Agora que o banco de dados está criado, anote o <em>endpoint</em>, que é o endereço para conectar no banco, a porta determinada (a porta padrão é 3306), o usuário e a senha definidos no passo anterior. Com estes dados é possível utilizar qualquer cliente MySQL para se conectar ao banco de dados.</p>
<p>Ainda não é possível se conectar ao banco de dados. Embora a opção Public access tenha sido marcada como Yes na criação do banco, serviços fora da VPC continuam não conseguindo acessar o banco porque não conseguem entrar na VPC. É necessário liberar o acesso, o que será feito listando o endereço IP da sua máquina na lista de endereços com autorização a se conectar na VPC.</p>
<h3 id="configuração-de-rede-na-vpc">Configuração de rede na VPC</h3>
<p>Utilize a barra de buscas a partir do menu Services para pesquisar por &ldquo;VPC&rdquo;. Clique no primeiro resultado. Será mostrada a tela inicial do serviço.</p>
<p>No menu de opções do serviço, clique em Security Groups, na seção Security. Será mostrada a lista de grupos de segurança configurados para a VPC padrão que é criada junto com a conta na AWS.</p>
<figure >
  
  <img data-src="images/figure6-vpc-configuration.webp" class="lazy" alt="Lista de grupos de segurança dentro da VPC padrão." title="Lista de grupos de segurança dentro da VPC padrão." />
  
  
  <figcaption>
    <p>Lista de grupos de segurança dentro da VPC padrão. Fonte: Autor.</p>
  </figcaption>
  
</figure>

<p>Cada grupo de segurança representa um conjunto de regras para a entrada e a saída de tráfego de cada serviço dentro da VPC. É possível criar diversos grupos com configurações diferentes para cada serviço. Neste exercício vamos apenas editar o grupo de segurança padrão para autorizar o endereço IP da sua máquina a acessar o banco de dados.</p>
<p>Clique no ID do grupo de segurança padrão. Nas abas Inbound rules e Outbound rules estão as regras de entrada e saída de tráfego, respectivamente. A regra de saída padrão é autorizar toda a saída de tráfego pela VPC. Clique em Edit inbound rules.</p>
<p>Clique no botão Add rule. Para cada regra no grupo de segurança devem ser especificados o tipo de tráfego, o protocolo, a porta e o endereço de origem. Para autorizar o endereço IP da sua máquina local a estabelecer uma conexão com o banco de dados selecione o tipo All TCP. O protocolo e a porta vão ser preenchidos automaticamente. Clique em Source e selecione My IP. Seu endereço de IP será adicionado a tabela. Clique em Save rules para aplicar a configuração.</p>
<p>Seu endereço de IP agora está autorizado a passar pela VPC e se conectar ao banco de dados pelo endpoint determinado na criação do banco. Vamos agora testar esta conexão.</p>
<h3 id="configuração-do-banco-de-dados">Configuração do banco de dados</h3>
<p>Para este exercício, vou utilizar o MySQL Workbench, que pode ser <a href="https://dev.mysql.com/downloads/workbench/" target="_blank" rel="noopener">baixado gratuitamente</a> no site do MySQL. Com o MySQL Workbench aberto, clique em nova conexão. Dê um nome para a conexão, mantenha o modo Standard (TCP/IP) selecionado e preencha os parâmetros Hostname, Port, Username e Password com os dados criados no processo de criação da nova instância MySQL na AWS. Clique em Test connection para verificar se está sendo possível se conectar ao banco a partir da sua máquina local. Se estiver tudo OK, clique em &ldquo;OK&rdquo; para abrir uma nova conexão com o banco de dados.</p>
<figure >
  
  <img data-src="images/figure7-mysql-workbench.webp" class="lazy" alt="Conexão aberta entre o banco de dados e o MySQL Workbench." title="Conexão aberta entre o banco de dados e o MySQL Workbench." />
  
  
  <figcaption>
    <p>Conexão aberta entre o banco de dados e o MySQL Workbench. Fonte: Autor.</p>
  </figcaption>
  
</figure>

<p>Vamos criar um banco de dados chamado rdstation. Para isso, monte a seguinte query no editor de queries:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="k">CREATE</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="n">rdstation</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
<p>Execute o comando clicando no ícone de raio, na barra de ferramentas acima do editor de texto ou pelo atalho CTRL + Enter (ou command + Enter). Um novo banco de dados foi criado. Precisamos agora criar uma tabela neste banco para armazenar os leads vindos do RD Station. Antes de criar a tabela precisamos selecionar o banco de dados. Para selecionar o banco de dados recém criado, execute a seguinte query:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="k">USE</span><span class="w"> </span><span class="n">rdstation</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
<p>Com o banco selecionado, crie a tabela leads:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="nf">leads</span><span class="p">(</span><span class="w">
</span><span class="w">	</span><span class="n">id</span><span class="w"> </span><span class="kt">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="no">NULL</span><span class="w"> </span><span class="kp">AUTO_INCREMENT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span><span class="w">
</span><span class="w">  </span><span class="n">email</span><span class="w"> </span><span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
<p>O banco de dados agora está configurado para receber os dados dos leads vindos pelo webhook.</p>
<h3 id="criação-da-função-lambda">Criação da função lambda</h3>
<p>O passo seguinte é configurar o serviço Lambda, que executa os trechos de código que vão acionar os demais serviços utilizados na arquitetura a ser criada. Os códigos são executados a partir de funções, invocadas após algum evento. Estas funções são chamadas de funções lambda. Não é necessário criar e configurar um ambiente para executar uma função lambda, isso já é feito na AWS. A única preocupação é escrever o código e carregá-lo para dentro do serviço.</p>
<p>Utilizando a barra de buscas, pesquise por &ldquo;Lambda&rdquo; e clique no primeiro resultado. Ao entrar na página do serviço Lambda, clique em &ldquo;Criar função&rdquo;.</p>
<figure >
  
  <img data-src="images/figure8-aws-lambda.webp" class="lazy" alt="Tela de configurações de criação de nova função na AWS." title="Tela de configurações de criação de nova função na AWS." />
  
  
  <figcaption>
    <p>Tela de configurações de criação de nova função na AWS. Fonte: Autor.</p>
  </figcaption>
  
</figure>

<p>A Amazon disponibiliza uma lista de templates para funções que normalmente são criadas. Para este exercício, vamos trabalhar com uma nova função em branco (Author from scratch).</p>
<p>O passo seguinte é dar um nome a função, seguindo as mesmas regras utilizadas por linguagens de programação.</p>
<p>Neste exercício será usada a linguagem Javascript rodando em ambiente Node.js. A versão mais recente disponível na data deste post será usada (12.x).</p>
<p>O passo seguinte é estabelecer as permissões de execução para esta função. É possível criar um conjunto de permissões (papel) sem sair da tela de criação da função lambda. Para isso, marque a opção &ldquo;Create a new role with basic Lambda permissions&rdquo;.</p>
<p>Por fim, clique em Create function.</p>
<figure >
  
  <img data-src="images/figure9-aws-test-function.webp" class="lazy" alt="Nova função criada no AWS Lambda." title="Nova função criada no AWS Lambda." />
  
  
  <figcaption>
    <p>Nova função criada no AWS Lambda. Fonte: Autor.</p>
  </figcaption>
  
</figure>

<p>Agora que a função está criada, precisamos configurar o momento em que ela será acionada. Conforme o desenho da arquitetura estabelecido no começo deste post, precisamos que a função seja chamada assim que a API receber os dados de um webhook. Vamos criar esta API a partir da função lambda criada.</p>
<p>No bloco Designer, clique em Add trigger. Expanda as opções no campo de busca que aparece e selecione API Gateway. Ao selecionar esta opção, um assistente de configuração de nova API vai abrir. Selecione Create an API e marque a opção REST API. Em segurança, mantenha a opção Open. Expanda as opções em Additional settings. Dê um nome para a API e, opcionalmente, um nome para o estágio de desenvolvimento padrão da API. Você pode criar diversos estágios de desenvolvimento, útil para separar os ambientes de desenvolvimento, de testes e de produção, por exemplo. Com as configurações feitas, clique em Add.</p>
<p>Volte para a página de configurações da função. Encontre o bloco de opções VPC. Precisamos adicionar esta função lambda dentro da VPC onde está o banco de dados. Esta não é a única forma de fazer esta conexão, é possível deixar a função lambda fora da VPC e estabelecer uma conexão com a VPC e com o banco. Mantendo a função lambda dentro da VPC, no entanto, eliminamos a etapa de configuração da conexão entre a função lambda e a VPC. <strong>Lembre-se: os objetos dentro da VPC não possuem acesso à internet por definição. Neste exercício será possível colocar a função lambda dentro da VPC pois a função só se conecta com o banco de dados que está dentro da VPC e não precisa chamar outros serviços na internet</strong>.</p>
<p>Em VPC, clique em Edit. Selecione a VPC padrão, as três subnets padrão e o grupo de segurança padrão. Note que ao selecionar o grupo de segurança padrão, a página irá listar todas as regras Inbound e Outbound definidas nas configurações do grupo de segurança, incluindo a que criamos para autorizar o endereço de IP da sua máquina local a acessar a VPC. Clique em Save.</p>
<p>A função está configurada, mas ainda faltam duas tarefas: dar permissão de leitura da API para a função criada e pegar o endereço do <em>endpoint</em> para o qual o webhook do RD Station deve mandar os dados.</p>
<h3 id="configurando-as-permissões-da-função-lambda">Configurando as permissões da função lambda</h3>
<p>Ao criar a função lambda, marcamos a opção para que um conjunto de permissões fosse criado com as permissões mínimas para que a função seja executada. Estas permissões mínimas autorizam a função a:</p>
<ul>
<li>Escrever logs no AWS CloudWatch;</li>
<li>Acessar e gravar dados no AWS EC2, que é o serviço de máquinas virtuais da AWS onde as funções ficam armazenadas.</li>
</ul>
<p>Precisamos autorizar a função a receber os dados da API que foi criada. Para fazer isso, acesse o menu Services e busque por &ldquo;IAM&rdquo;. Clique no primeiro resultado. No menu de opções, clique em Roles.</p>
<figure >
  
  <img data-src="images/figure10-aws-iam.webp" class="lazy" alt="Lista de papéis que foram criados a medida que configuramos os serviços na AWS." title="Lista de papéis que foram criados a medida que configuramos os serviços na AWS." />
  
  
  <figcaption>
    <p>Lista de papéis que foram criados a medida que configuramos os serviços na AWS. Fonte: Autor.</p>
  </figcaption>
  
</figure>

<p>O papel criado com a função possui o nome dela. Clique neste papel.</p>
<p>Clique no botão &ldquo;Attach policies&rdquo;. A página vai exibir uma lista de possíveis permissões que podem ser aplicadas a este papel. Na caixa de busca, encontre a permissão &ldquo;AmazonAPIGatewayInvokeFullAccess&rdquo;. Selecione a permissão e clique em &ldquo;Attach policy&rdquo;. A permissão será adicionada ao papel, e todos os serviços que fazem uso deste papel terão esta e as demais permissões deste papel.</p>
<h3 id="encontrando-o-endereço-da-api">Encontrando o endereço da API</h3>
<p>A última etapa da configuração básica é pegar o endereço do endpoint na API criada. Para fazer isso, acesse o menu Services. Na caixa de busca, digite por &ldquo;API&rdquo; e clique na primeira opção. A tela inicial irá mostrar que já existe uma API criada, a que foi criada ao determinar o gatilho da função lambda. Clique nesta API. Veja que já existe um endpoint criado para esta API com o nome que você deu para a função. Ao ser publicada, a API recebeu um <em>endpoint</em> com o seguinte formato: https://endereco-da-api/estagio/nomeDaFuncao, onde estágio é o nome do estágio padrão criado no momento de criação da API e nomeDaFuncao é o recurso que está associado a função lambda. Se você não incluir na URL o nome da função (também chamado de recurso ou método) no endereço de chamada a API, você vai ver um erro na tela ao acessar este endereço direto no navegador dizendo &ldquo;Missing authentication token&rdquo;.</p>
<p>Para encontrar o endereço da API criada, acesse o menu Stages e clique no estágio que foi criado na etapa de criação da API. Anote o endereço em Invoke URL. Note que este endereço não está com o recurso anexado (não tem o nome da função após o nome do estágio). O endereço completo precisa ter o nome do recurso. Para saber qual o nome exato do recurso, basta ir em Resources, acima de Stages no menu.</p>
<h2 id="o-orquestrador">O orquestrador</h2>
<p>A função lambda criada irá orquestrar os demais recursos da infraestrutura. Precisamos ensiná-la a fazer isso. Vá até a página do serviço lambda e acesse a função criada. Podemos criar os comandos direto no editor fornecido pela AWS. Há uma limitação com o editor padrão, no entanto: não podemos instalar pacotes. No caso do Node.js, não podemos utilizar o NPM (Node Package Manager). Precisamos do pacote mysql para criar a conexão com o banco de dados dentro da função lambda e este pacote não está instalado neste ambiente. Todas as dependências necessárias para o projeto precisam ser carregadas no ambiente.</p>
<p>Para carregar os arquivos necessários, crie uma pasta em um diretório do seu computador e comece um novo projeto em Node.js na raiz desta pasta. Caso não possua o Node.js instalado em sua máquina, <a href="https://nodejs.org/en/" target="_blank" rel="noopener">faça a instalação</a> antes de seguir.</p>
<p>Uma vez que o Node.js esteja instalado em sua máquina, abra um terminal e acesse a pasta raiz do projeto a ser carregado no AWS Lambda. Dentro da pasta, rode o comando:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">npm init</code></pre></td></tr></table>
</div>
</div>
<p>O comando irá pedir algumas informações para a inicialização do projeto, como nome do autor e arquivo de inicialização. Preencha as informações do pacote como preferir, mantenha o ponto de entrada na função como sendo o arquivo index.js e confirme as opções quando estiver tudo preenchido.</p>
<p>É necessário instalar o pacote mysql, <a href="https://www.npmjs.com/package/mysql" target="_blank" rel="noopener">disponível no NPM</a>. Rode o seguinte comando no terminal:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">npm install mysql</code></pre></td></tr></table>
</div>
</div>
<p>O pacote será instalado na pasta do projeto, junto com suas dependências, dentro de uma pasta chamada node_modules.</p>
<p>Com o mysql instalado, podemos utilizá-lo para fazer a conexão com o banco de dados.</p>
<p>Abra seu editor de códigos preferido e crie, na raiz da pasta do projeto, um arquivo chamado index.js. Este arquivo irá armazenar o código que vamos escrever para receber o webhook do RD Station e armazenar seus dados no banco de dados.</p>
<h3 id="a-estrutura-básica-de-uma-função-lambda">A estrutura básica de uma função lambda</h3>
<p>Toda função lambda é iniciada com uma estrutura básica. Em Javascript rodando no ambiente Node.js, esta estrutura é:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
	<span class="c1">// TODO
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">statusCode</span><span class="o">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="s1">&#39;Hello from lambda!&#39;</span><span class="p">)</span>
  <span class="p">};</span>
  <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>Este objeto handler contém o &ldquo;coração&rdquo; da função lambda. As ações de importância são executadas dentro de uma função armazenada no objeto handler e o status da execução é retornado ao final. Antes de escrever o código da função, faremos um ajuste para executá-la de forma síncrona:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">callbackWaitsForEmptyEventLoop</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">statusCode</span><span class="o">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;Hello from lambda!&#39;</span><span class="p">,</span>
    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
      <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
      <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">:</span> <span class="s1">&#39;*&#39;</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>Há alguns pontos de atenção na reescrita desta função:</p>
<ul>
<li>A função sendo inicializada agora recebe três parâmetros;</li>
<li>O retorno é dado por uma função chamada callback;</li>
<li>Dizemos para o objeto context que as chamadas a função callback não devem esperar o processamento da <a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/" target="_blank" rel="noopener">fila de eventos</a> antes de sua execução;</li>
<li>O objeto de retorno agora tem uma propriedade de cabeçalhos que passa cabeçalhos web. O cabeçalho Access-Control-Allow-Origin permite que a API seja chamada por serviços web de fora do domínio onde a API está hospedada, <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-cors.html" target="_blank" rel="noopener">e é obrigatório para que a API possa receber os dados do webhook</a>.</li>
</ul>
<p>Com a configuração feita, vamos escrever o código da função no index.js.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mysql&#39;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">handleEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">body</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>

  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">handleCallback</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">status_code</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">statusCode</span><span class="o">:</span> <span class="nx">status_code</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="nx">message</span><span class="p">,</span>
    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
      <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
      <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">:</span> <span class="s1">&#39;*&#39;</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>Começamos importando o pacote mysql. Em seguida, criamos duas funções: handleEvent e handleCallback. A função handleEvent trata o objeto event. Este objeto possui informações sobre a requisição feita e possui uma propriedade chamada body. Quando uma requisição do tipo POST é feita e o corpo da requisição é preenchido (caso do webhook do RD Station), esta propriedade do objeto estará preenchida. Para tornar o exercício simples, apenas é verificado se a propriedade body do objeto evento está preenchida e, caso esteja, tenta fazer a conversão (parse) do objeto assumindo que ele está no formato JSON.</p>
<p>A função seguinte, handleCallback, abstrai a chamada a callback, recebida ao invocar a função associada ao objeto handler. Esta função retorna para o solicitante o resultado da execução da função.</p>
<p>Vamos agora criar o objeto de conexão com o banco.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">({</span>
  <span class="nx">host</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RDS_HOST</span><span class="p">,</span>
  <span class="nx">user</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RDS_USER</span><span class="p">,</span>
  <span class="nx">password</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RDS_PASSWORD</span><span class="p">,</span>
  <span class="nx">port</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RDS_PORT</span><span class="p">,</span>
  <span class="nx">database</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RDS_DATABASE</span>
<span class="p">});</span></code></pre></td></tr></table>
</div>
</div>
<p>Vamos criar na função lambda algumas variáveis de ambiente que vão armazenar as credenciais de acesso ao banco. A AWS possui um serviço feito para armazenar este tipo de informação chamado AWS Secrets Manager. O recurso, no entanto, está fora da lista de recursos que podem ser usados gratuitamente.</p>
<p>Com os preparativos feitos, vamos agora escrever a função que irá receber o webhook e gravar seus dados banco de dados.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">callbackWaitsForEmptyEventLoop</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="kd">let</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">handleEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">response</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;leads&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">lead</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">leads</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Esta sintaxe do comando INSERT é válida no MySQL, mas não é padrão da linguagem
</span><span class="c1"></span>      <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;INSERT INTO leads SET ?&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="nx">lead</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="nx">lead</span><span class="p">.</span><span class="nx">email</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>

        <span class="nx">handleCallback</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;ok&#39;</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="nx">handleCallback</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;Script ended&#39;</span><span class="p">);</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
<p>Esta função:</p>
<ul>
<li>Determina que a função callback não precisa esperar o término de outros eventos que ainda precisem ser processados;</li>
<li>Verifica se o corpo de uma requisição a API existe e possui dados no formato JSON;</li>
<li>Verifica se o objeto retornado possui uma propriedade chamada leads*;</li>
<li>Caso não possua leads, invoca a função callback;</li>
<li>Caso possua leads, dá um intervalo de 1 segundo para que uma query de inserção no banco de dados seja executada.</li>
</ul>
<p>* <a href="https://developers.rdstation.com/pt-BR/migration/webhooks" target="_blank" rel="noopener">O formato do webhook irá mudar</a>. Para referência, este é o conteúdo que esperamos receber na data de escrita deste post:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="s2">&#34;leads&#34;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&#34;id&#34;</span><span class="o">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
      <span class="s2">&#34;uuid&#34;</span><span class="o">:</span> <span class="s2">&#34;c2f3d2b3-......-eef38be32f7f&#34;</span><span class="p">,</span>
      <span class="s2">&#34;email&#34;</span><span class="o">:</span> <span class="s2">&#34;email@email.com&#34;</span><span class="p">,</span>
      <span class="s2">&#34;name&#34;</span><span class="o">:</span> <span class="s2">&#34;Lead Name&#34;</span><span class="p">,</span>
      <span class="s2">&#34;company&#34;</span><span class="o">:</span> <span class="s2">&#34;Company Name&#34;</span><span class="p">,</span>
      <span class="s2">&#34;job_title&#34;</span><span class="o">:</span> <span class="s2">&#34;Job&#34;</span><span class="p">,</span>
      <span class="s2">&#34;bio&#34;</span><span class="o">:</span> <span class="s2">&#34;This is my bio&#34;</span><span class="p">,</span>
      <span class="s2">&#34;created_at&#34;</span><span class="o">:</span> <span class="s2">&#34;2012-06-04T15:31:35-03:00&#34;</span><span class="p">,</span>
      <span class="s2">&#34;opportunity&#34;</span><span class="o">:</span> <span class="s2">&#34;false&#34;</span><span class="p">,</span>
      <span class="s2">&#34;number_conversions&#34;</span><span class="o">:</span> <span class="s2">&#34;3&#34;</span><span class="p">,</span>
      <span class="s2">&#34;user&#34;</span><span class="o">:</span> <span class="s2">&#34;email@example.com&#34;</span><span class="p">,</span>
      <span class="s2">&#34;first_conversion&#34;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&#34;content&#34;</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">&#34;identificador&#34;</span><span class="o">:</span> <span class="s2">&#34;ebook-abc&#34;</span><span class="p">,</span>
          <span class="s2">&#34;nome&#34;</span><span class="o">:</span> <span class="s2">&#34;Lead Name&#34;</span><span class="p">,</span>
          <span class="s2">&#34;email_lead&#34;</span><span class="o">:</span> <span class="s2">&#34;email@email.com&#34;</span><span class="p">,</span>
          <span class="s2">&#34;telefone&#34;</span><span class="o">:</span> <span class="s2">&#34;99999999&#34;</span><span class="p">,</span>
          <span class="s2">&#34;empresa&#34;</span><span class="o">:</span> <span class="s2">&#34;Company Name&#34;</span><span class="p">,</span>
          <span class="s2">&#34;cargo&#34;</span><span class="o">:</span> <span class="s2">&#34;IT&#34;</span>
        <span class="p">},</span>
        <span class="s2">&#34;created_at&#34;</span><span class="o">:</span> <span class="s2">&#34;2012-06-04T15:31:35-03:00&#34;</span><span class="p">,</span>
        <span class="s2">&#34;cumulative_sum&#34;</span><span class="o">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
        <span class="s2">&#34;source&#34;</span><span class="o">:</span> <span class="s2">&#34;source 1&#34;</span><span class="p">,</span>
        <span class="s2">&#34;conversion_origin&#34;</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">&#34;source&#34;</span><span class="o">:</span> <span class="s2">&#34;source 1&#34;</span><span class="p">,</span>
          <span class="s2">&#34;medium&#34;</span><span class="o">:</span> <span class="s2">&#34;medium 1&#34;</span><span class="p">,</span>
          <span class="s2">&#34;value&#34;</span><span class="o">:</span> <span class="s2">&#34;value 1&#34;</span><span class="p">,</span>
          <span class="s2">&#34;campaign&#34;</span><span class="o">:</span> <span class="s2">&#34;campaign 1&#34;</span><span class="p">,</span>
          <span class="s2">&#34;channel&#34;</span><span class="o">:</span> <span class="s2">&#34;channel 1&#34;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="s2">&#34;last_conversion&#34;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&#34;content&#34;</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">&#34;identificador&#34;</span><span class="o">:</span> <span class="s2">&#34;webinar-abc&#34;</span><span class="p">,</span>
          <span class="s2">&#34;email_lead&#34;</span><span class="o">:</span> <span class="s2">&#34;support@example.org&#34;</span>
        <span class="p">},</span>
        <span class="s2">&#34;created_at&#34;</span><span class="o">:</span> <span class="s2">&#34;2012-06-04T15:31:35-03:00&#34;</span><span class="p">,</span>
        <span class="s2">&#34;cumulative_sum&#34;</span><span class="o">:</span> <span class="s2">&#34;2&#34;</span><span class="p">,</span>
        <span class="s2">&#34;source&#34;</span><span class="o">:</span> <span class="s2">&#34;source 2&#34;</span>
      <span class="p">},</span>
      <span class="s2">&#34;custom_fields&#34;</span><span class="o">:</span> <span class="p">{},</span>
      <span class="s2">&#34;website&#34;</span><span class="o">:</span> <span class="s2">&#34;http://www.mywebsite.com&#34;</span><span class="p">,</span>
      <span class="s2">&#34;personal_phone&#34;</span><span class="o">:</span> <span class="s2">&#34;48 999999999&#34;</span><span class="p">,</span>
      <span class="s2">&#34;mobile_phone&#34;</span><span class="o">:</span> <span class="s2">&#34;48 999999999&#34;</span><span class="p">,</span>
      <span class="s2">&#34;city&#34;</span><span class="o">:</span> <span class="s2">&#34;Florianópolis&#34;</span><span class="p">,</span>
      <span class="s2">&#34;state&#34;</span><span class="o">:</span> <span class="s2">&#34;SC&#34;</span><span class="p">,</span>
      <span class="s2">&#34;lead_stage&#34;</span><span class="o">:</span> <span class="s2">&#34;Lead&#34;</span><span class="p">,</span>
      <span class="s2">&#34;tags&#34;</span><span class="o">:</span> <span class="p">[</span>
        <span class="s2">&#34;tag 1&#34;</span><span class="p">,</span>
        <span class="s2">&#34;tag 2&#34;</span>
      <span class="p">],</span>
      <span class="s2">&#34;fit_score&#34;</span><span class="o">:</span> <span class="s2">&#34;d&#34;</span><span class="p">,</span>
      <span class="s2">&#34;interest&#34;</span><span class="o">:</span> <span class="mi">0</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>Este é o arquivo index.js completo:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">mysql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mysql&#39;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">handleEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">body</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>

  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">handleCallback</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">status_code</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">statusCode</span><span class="o">:</span> <span class="nx">status_code</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="nx">message</span><span class="p">,</span>
    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
      <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
      <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">:</span> <span class="s1">&#39;*&#39;</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">mysql</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">({</span>
  <span class="nx">host</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RDS_HOST</span><span class="p">,</span>
  <span class="nx">user</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RDS_USER</span><span class="p">,</span>
  <span class="nx">password</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RDS_PASSWORD</span><span class="p">,</span>
  <span class="nx">port</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RDS_PORT</span><span class="p">,</span>
  <span class="nx">database</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RDS_DATABASE</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">callbackWaitsForEmptyEventLoop</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="kd">let</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">handleEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">response</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;leads&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">lead</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">leads</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Esta sintaxe do comando INSERT é válida no MySQL mas não é padrão da linguagem
</span><span class="c1"></span>      <span class="nx">connection</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;INSERT INTO leads SET ?&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="nx">lead</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="nx">lead</span><span class="p">.</span><span class="nx">email</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">connection</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>

        <span class="nx">handleCallback</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;ok&#39;</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="nx">handleCallback</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;Script ended&#39;</span><span class="p">);</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
<p>Salve o arquivo. Selecione todos os arquivos e pastas criados (index.js, a pasta node_modules e o arquivo package.json) e os adicione em um arquivo compactado. O formato do arquivo compactado deve ser zip.</p>
<figure >
  
  <img data-src="images/figure11-aws-lambda-function.webp" class="lazy" alt="Pasta compactada com os arquivos index.js, node_modules e package.json." title="Pasta compactada com os arquivos index.js, node_modules e package.json." />
  
  
  <figcaption>
    <p>Pasta compactada com os arquivos index.js, node_modules e package.json. Fonte: Autor.</p>
  </figcaption>
  
</figure>

<p>Com a pasta compactada contendo os arquivos do projeto, acesse o painel do AWS Lambda e, dentro do bloco Function code, clique no botão Actions &gt; Upload a .zip file. Uma janela de seleção de arquivos vai se abrir. Selecione o arquivo compactado com os arquivos do projeto e clique em Save. Estes arquivos estarão disponíveis no editor da função lambda, assim como o pacote mysql e suas dependências.</p>
<h3 id="configurando-as-variáveis-de-ambiente">Configurando as variáveis de ambiente</h3>
<p>Na criação do objeto de conexão com o banco de dados, utilizamos cinco variáveis de ambiente:</p>
<ul>
<li>RDS_HOST;</li>
<li>RDS_PORT;</li>
<li>RDS_DATABASE;</li>
<li>RDS_USER;</li>
<li>RDS_PASSWORD.</li>
</ul>
<p>Precisamos criar estas variáveis no ambiente lambda. Navegue até o bloco Environment variables, abaixo do editor de código, e clique em Edit. Adicione no campo Key o nome RDS_HOST e no campo Value o endpoint obtido ao criar o banco de dados. Clique em Add environment variable para adicionar mais uma variável de ambiente no projeto. Crie as demais variáveis e adicione as configurações obtidas ao criar a instância do banco de dados e o banco de dados em si. Clique em Save quando terminar. Ao final, cinco variáveis de ambiente devem ter sido criadas, que correspondem as credenciais de acesso ao banco de dados.</p>
<h2 id="configurando-o-webhook-no-rd-station">Configurando o webhook no RD Station</h2>
<p>O passo final é ativar o disparo de webhooks no RD Station, <a href="/stories/rd-station-e-google-sheets/" >o que pode ser feito via configurações da conta do RD Station ou via fluxos de automação</a>. Basta seguir o mesmo procedimento apresentado no post de integração entre o RD Station e o Google Sheets, trocando apenas o endereço para envio do webhook. No lugar do endereço do GAS será utilizado o endereço da API criada no AWS API Gateway. Lembre-se que o endereço deve conter o nome do endpoint e o recurso.</p>
<p>Tudo pronto! Os leads do RD Station agora estão sendo armazenados em um banco de dados relacional na AWS.</p>
<h2 id="opcional-desabilite-o-acesso-público-ao-endpoint-do-banco-de-dados">Opcional: desabilite o acesso público ao endpoint do banco de dados</h2>
<p>Caso deseje, você pode desabilitar o acesso de dispositivos fora da VPC ao endpoint do banco de dados e assim garantir que apenas a função lambda tenha permissão de acesso am banco de dados. Para isso, acesse o menu Services e busque por RDS (ou utilize a barra de histórico ao lado do menu de opções para selecionar o serviço).</p>
<p>Clique em databases e selecione a instância criada para o banco de dados.</p>
<p>Clique no botão Modify.</p>
<p>No bloco de opções Connectivity, clique em Additional connectivity configuration e em Public access marque a opção Not publicly accessible. Clique no botão Continue no final da página para que a instância do banco de dados seja atualizada com a nova configuração.</p>
<h2 id="próximos-passos">Próximos passos</h2>
<p>Ao executar este exercício, você teve uma breve introdução a alguns dos serviços oferecidos pela AWS. Esta mesma arquitetura poderia ter sido feita de outras formas, utilizando outros serviços. O RD Station pode ser apenas uma fonte de entrada para um Data Warehouse ou um Data Lake, ou ainda poderia ter passado por um pipeline de dados mais complexo antes de ser armazenado no banco de dados. As possibilidades são diversas e a forma de implementação irá depender da necessidade de cada projeto. A <a href="https://docs.aws.amazon.com/index.html" target="_blank" rel="noopener">documentação da AWS</a> é uma ótima fonte de informações, bem como os inúmeros posts no Stack Overflow de pessoas que tiveram dificuldades ao configurar os recursos da AWS.</p>
<p>Lembre-se do problema ilustrado no início do post com a integração entre o RD Station e o Google Sheets: o alto volume de leads simultâneos. Muitos leads sendo enviados simultaneamente para a API podem resultar em diversas instâncias da função lambda sendo executadas e diversas conexões com o banco de dados abertas. A solução dada no início do post para separar a base de leads por uma data de corte funciona funciona aqui também. Esta solução evita o desperdício de recursos computacionais e o aumento dos custos decorrentes desta operação na AWS.</p>
<p>Bora continuar automatizando!</p>

      </main>
      <footer>
        


<div class="h-1 w-16 my-6 bg-gray-900 mx-auto dark:bg-white"></div>
<div class="flex justify-center items-center" itemprop="author" itemscope itemtype="https://schema.org/Person">
  <div class="mr-4 w-3/12 md:w-2/12">
    <img class="rounded-full" src="/images/profiles/henriquesouza/profile.webp" alt="Henrique Freitas Souza" itemprop="image">
  </div>
  <div class="w-9/12 md:w-10/12">
    <address class="font-title dark:text-white" itemprop="name">Henrique Freitas Souza</address>
    
    <p class="mb-auto text-base dark:text-white" itemprop="description">Certa vez li que dados são como resíduos nucleares. Desde então tomo cuidado redobrado com o uso que faço deles.</p>
    
  </div>
</div>


      </footer>
    </div>
  </div>
</article>

  
  
<div class="container container-box mx-auto">
  <div class="px-2 lg:px-0">
    <aside role="complementary">
      <span class="inline-block w-full font-title text-3xl text-center mb-4 px-2 dark:text-white">Leia também estas histórias</span>
      <div class="lg:flex lg:flex-wrap lg:justify-start">
        
          




<div class="mb-4 lg:mb-0 lg:p-2 lg:w-1/2 xl:w-1/3">
  <article class="relative flex flex-col bg-gray-300 p-6 h-full rounded-lg dark:bg-secondary-darker" role="article" itemscope itemtype="https://schema.org/Article">
  
    
    <div class="absolute inset-0 bg-cover bg-center filter brightness-50 rounded-lg" style="background-image: url('/stories/configurando-metabase-e-postgresql-no-docker/images/thumbnail_hu46ba3eab324bd3b57676d5fcac380c13_42865_500x500_fill_q75_box_smart1.jpg');"></div>
  
    <header class="relative flex flex-wrap justify-between items-center mb-6">
      
      <div>
        <address class="text-white text-base" itemprop="author">Henrique</address>
        <time class="text-white text-base" itemprop="datePublished" pubdate datetime="2020-11-17 09:10:00 &#43;0000 UTC">17/11/2020 09:10:00</time>
      </div>
      <a href="/categories/automa%C3%A7%C3%A3o" class="badge" itemprop="articleSection">automação</a>
      
    </header>
    <main class="relative" itemprop="articleBody">
      
      <h2 class="text-white" itemprop="headline">Configurando Metabase e PostgreSQL no Docker</h2>
      <p class="mb-6 text-white" itemprop="abstract">Como elaborar uma arquitetura de serviços simples, de fácil manutenção e portátil utilizando o Docker? Ao longo deste post, você vai descobrir como fazer isso integrando um banco de dados PostgreSQL …</p>
      <div>
        <a class="button-primary" href="/stories/configurando-metabase-e-postgresql-no-docker/">Leia mais</a>
      </div>
      
    </main>
  </article>
</div>

        
          




<div class="mb-4 lg:mb-0 lg:p-2 lg:w-1/2 xl:w-1/3">
  <article class="relative flex flex-col bg-gray-300 p-6 h-full rounded-lg dark:bg-secondary-darker" role="article" itemscope itemtype="https://schema.org/Article">
  
    
    <div class="absolute inset-0 bg-cover bg-center filter brightness-50 rounded-lg" style="background-image: url('/stories/rd-station-e-google-sheets/images/thumbnail_hu9a8e1eb5a7452283d6f6255f788ec07e_26449_500x500_fill_q75_box_smart1.jpg');"></div>
  
    <header class="relative flex flex-wrap justify-between items-center mb-6">
      
      <div>
        <address class="text-white text-base" itemprop="author">Henrique</address>
        <time class="text-white text-base" itemprop="datePublished" pubdate datetime="2018-09-02 14:07:00 &#43;0000 UTC">02/09/2018 14:07:00</time>
      </div>
      <a href="/categories/automa%C3%A7%C3%A3o" class="badge" itemprop="articleSection">automação</a>
      
    </header>
    <main class="relative" itemprop="articleBody">
      
      <h2 class="text-white" itemprop="headline">RD Station e Google Sheets: exportação automática de leads para planilhas</h2>
      <p class="mb-6 text-white" itemprop="abstract">Saiba como enviar dados de leads automaticamente para planilhas no Google Sheets a partir do software de automação de marketing RD Station.</p>
      <div>
        <a class="button-primary" href="/stories/rd-station-e-google-sheets/">Leia mais</a>
      </div>
      
    </main>
  </article>
</div>

        
          




<div class="mb-4 lg:mb-0 lg:p-2 lg:w-1/2 xl:w-1/3">
  <article class="relative flex flex-col bg-gray-300 p-6 h-full rounded-lg dark:bg-secondary-darker" role="article" itemscope itemtype="https://schema.org/Article">
  
    
    <div class="absolute inset-0 bg-cover bg-center filter brightness-50 rounded-lg" style="background-image: url('/stories/apis-e-carrinhos-de-supermercado/images/thumbnail_hu46c54be97ab545b46d52504c6747000a_184568_500x500_fill_q75_box_smart1.jpg');"></div>
  
    <header class="relative flex flex-wrap justify-between items-center mb-6">
      
      <div>
        <address class="text-white text-base" itemprop="author">Henrique</address>
        <time class="text-white text-base" itemprop="datePublished" pubdate datetime="2018-07-04 21:20:00 &#43;0000 UTC">04/07/2018 21:20:00</time>
      </div>
      <a href="/categories/automa%C3%A7%C3%A3o" class="badge" itemprop="articleSection">automação</a>
      
    </header>
    <main class="relative" itemprop="articleBody">
      
      <h2 class="text-white" itemprop="headline">APIs e carrinhos de supermercado</h2>
      <p class="mb-6 text-white" itemprop="abstract">O que é uma API e para que serve? Este post vai introduzir o conceito sem entrar em aspectos técnicos.</p>
      <div>
        <a class="button-primary" href="/stories/apis-e-carrinhos-de-supermercado/">Leia mais</a>
      </div>
      
    </main>
  </article>
</div>

        
      </div>
    </aside>
  </div>
</div>
  


      </main>
      <footer>
        <div class="bg-secondary-darker">
  <div class="container container-box mx-auto">
    <div class="flex flex-wrap justify-between px-2 lg:px-0">
      <div class="w-full mb-6 last:mb-auto lg:mb-auto lg:p-2 lg:w-2/4">
        <div class="flex items-center mb-4">
          <img src="https://www.automacaodedados.com.br/images/automacaodedados_logo_white.svg" alt="Logo Automação de Dados" class="mr-2 w-16 h-8">
          <span class="font-title inline-block text-white text-base">Automação de Dados</span>
        </div>
        <p class="text-white">Espaço para a divulgação de informações que ajudem a democratizar o conhecimento sobre novas tecnologias no Brasil.</p>
      </div>
      <div class="w-full mb-6 last:mb-auto lg:mb-auto lg:p-2 lg:w-1/4">
  <span class="font-title inline-block mb-4 text-white text-base">Todas as categorias</span>
  <nav role="navigation" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul class="list-none ml-auto">
      
      <li class="mb-2 last:mb-auto" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="text-white no-underline hover:text-white hover:underline dark:hover:text-white" href="/categories/analytics/" itemprop="item">
          <span class="text-white" itemprop="name">Analytics</span>
        </a>
      </li>
      
      <li class="mb-2 last:mb-auto" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="text-white no-underline hover:text-white hover:underline dark:hover:text-white" href="/categories/an%C3%A1lise/" itemprop="item">
          <span class="text-white" itemprop="name">Análise</span>
        </a>
      </li>
      
      <li class="mb-2 last:mb-auto" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="text-white no-underline hover:text-white hover:underline dark:hover:text-white" href="/categories/automa%C3%A7%C3%A3o/" itemprop="item">
          <span class="text-white" itemprop="name">Automação</span>
        </a>
      </li>
      
      <li class="mb-2 last:mb-auto" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="text-white no-underline hover:text-white hover:underline dark:hover:text-white" href="/categories/design/" itemprop="item">
          <span class="text-white" itemprop="name">Design</span>
        </a>
      </li>
      
      <li class="mb-2 last:mb-auto" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="text-white no-underline hover:text-white hover:underline dark:hover:text-white" href="/categories/empreendedorismo/" itemprop="item">
          <span class="text-white" itemprop="name">Empreendedorismo</span>
        </a>
      </li>
      
      <li class="mb-2 last:mb-auto" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="text-white no-underline hover:text-white hover:underline dark:hover:text-white" href="/categories/estat%C3%ADstica/" itemprop="item">
          <span class="text-white" itemprop="name">Estatística</span>
        </a>
      </li>
      
      <li class="mb-2 last:mb-auto" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="text-white no-underline hover:text-white hover:underline dark:hover:text-white" href="/categories/governan%C3%A7a/" itemprop="item">
          <span class="text-white" itemprop="name">Governança</span>
        </a>
      </li>
      
      <li class="mb-2 last:mb-auto" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="text-white no-underline hover:text-white hover:underline dark:hover:text-white" href="/categories/marketing/" itemprop="item">
          <span class="text-white" itemprop="name">Marketing</span>
        </a>
      </li>
      
      <li class="mb-2 last:mb-auto" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="text-white no-underline hover:text-white hover:underline dark:hover:text-white" href="/categories/programa%C3%A7%C3%A3o/" itemprop="item">
          <span class="text-white" itemprop="name">Programação</span>
        </a>
      </li>
      
      <li class="mb-2 last:mb-auto" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="text-white no-underline hover:text-white hover:underline dark:hover:text-white" href="/categories/visualiza%C3%A7%C3%A3o/" itemprop="item">
          <span class="text-white" itemprop="name">Visualização</span>
        </a>
      </li>
      
    </ul>
  </nav>
</div>
<div class="w-full mb-6 last:mb-auto lg:mb-auto lg:p-2 lg:w-1/4">
  <span class="font-title inline-block mb-4 text-white text-base">Últimas histórias</span>
  <nav role="navigation" itemscope itemtype="https://schema.org/SiteNavigationElement">
    <ul class="list-none ml-auto">
      
      <li class="mb-2 last:mb-auto" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="text-white no-underline hover:text-white hover:underline dark:hover:text-white" href="/stories/o-metaverso-pos-meta/" itemprop="item">
          <span class="text-white" itemprop="name">O Metaverso pós Meta</span>
        </a>
      </li>
      
      <li class="mb-2 last:mb-auto" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="text-white no-underline hover:text-white hover:underline dark:hover:text-white" href="/stories/construcao-da-identidade-no-espaco-virtual/" itemprop="item">
          <span class="text-white" itemprop="name">Construção da identidade no espaço virtual</span>
        </a>
      </li>
      
      <li class="mb-2 last:mb-auto" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="text-white no-underline hover:text-white hover:underline dark:hover:text-white" href="/stories/como-escolher-o-melhor-grafico/" itemprop="item">
          <span class="text-white" itemprop="name">Como escolher o melhor gráfico?</span>
        </a>
      </li>
      
    </ul>
  </nav>
</div>

    </div>
  </div>
</div>
<div class="bg-gray-300">
  <div class="container container-box mx-auto">
    <div class="text-center lg:flex lg:justify-between lg:items-center lg:text-left px-2">
      <span class="inline-block text-base dark:text-gray-900">Feito com Hugo &#43; Tailwind e hospedado no Github Pages.</span>
      <div itemscope itemtype="https://schema.org/Language">
        <ul class="ml-auto mb-0">
          
          <li class="inline-block" itemprop="availableLanguage" itemscope itemtype="https://schema.org/Language">
            <a class="px-2 py-1 text-base no-underline hover:text-gray-900 hover:underline dark:text-gray-900 dark:hover:text-gray-900" href="/" itemprop="name">🇧🇷 Português</a>
          </li>
          
          <li class="inline-block" itemprop="availableLanguage" itemscope itemtype="https://schema.org/Language">
            <a class="px-2 py-1 text-base no-underline hover:text-gray-900 hover:underline dark:text-gray-900 dark:hover:text-gray-900" href="/en/" itemprop="name">🇺🇸 English</a>
          </li>
          
        </ul>
      </div>
    </div>
  </div>
</div>

      </footer>
    </div>
    <script src="/js/theme.min.js"></script>

    
<script src="/js/lazy.min.js" async></script>

  </body>
</html>
